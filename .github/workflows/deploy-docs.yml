name: Deploy API Documentation

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  security-scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: pip install -r requirements.txt
      
      - name: Run Bandit security scan
        run: |
          bandit -r . -f html -o bandit-report.html || echo "Bandit scan completed"
          ls -la bandit-report.html || echo "Report file not created"
      
      - name: Upload Bandit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bandit-report
          path: bandit-report.html

  generate-openapi:
    runs-on: ubuntu-latest
    needs: security-scan
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: pip install -r requirements.txt
      
      - name: Generate OpenAPI specification
        run: |
          python -c "
from app import app
import yaml

# –ü–æ–ª—É—á–∞–µ–º —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—é OpenAPI –∏–∑ Flasgger
spec = app.extensions['flasgger'].swagger

# –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ñ–∞–π–ª
with open('openapi.yaml', 'w', encoding='utf-8') as f:
    yaml.dump(spec, f, allow_unicode=True, default_flow_style=False)

print('‚úÖ OpenAPI specification generated successfully!')
          "
      
      - name: Verify OpenAPI file
        run: |
          echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ OpenAPI —Ñ–∞–π–ª–∞ ==="
          if [ -f openapi.yaml ]; then
            echo "‚úÖ –§–∞–π–ª openapi.yaml —Å–æ–∑–¥–∞–Ω"
            echo "–ü–µ—Ä–≤—ã–µ 5 —Å—Ç—Ä–æ–∫ —Ñ–∞–π–ª–∞:"
            head -5 openapi.yaml
            echo "–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞:"
            ls -lh openapi.yaml
          else
            echo "‚ùå –§–∞–π–ª openapi.yaml –Ω–µ –Ω–∞–π–¥–µ–Ω!"
            exit 1
          fi
      
      - name: Upload OpenAPI spec
        uses: actions/upload-artifact@v4
        with:
          name: openapi-spec
          path: openapi.yaml

  deploy-documentation:
    runs-on: ubuntu-latest
    needs: generate-openapi
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download OpenAPI spec
        uses: actions/download-artifact@v4
        with:
          name: openapi-spec
          path: ./
      
      - name: Setup Pages
        uses: actions/configure-pages@v3
      
      - name: Install Redocly CLI
        run: npm install -g @redocly/cli@latest
      
      - name: Create docs directory
        run: mkdir -p docs
      
      - name: Generate ReDoc documentation
        run: redocly build-docs openapi.yaml --output=docs/index.html
      
      - name: Add simple HTML wrapper
        run: |
          cat > docs/index.html << 'EOF'
<!DOCTYPE html>
<html>
<head>
    <title>Phone Contacts API Documentation</title>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { margin: 0; padding: 0; }
        .header { 
            background: #667eea; 
            color: white; 
            padding: 20px; 
            text-align: center; 
        }
        .info { 
            background: #f5f5f5; 
            padding: 15px; 
            margin: 20px; 
            border-radius: 5px; 
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üì± Phone Contacts API</h1>
        <p>Documentation for Phone Contacts REST API</p>
    </div>
    <div class="info">
        <p>This API provides endpoints for managing phone contacts:</p>
        <ul>
            <li><strong>POST /contacts</strong> - Create new contact</li>
            <li><strong>GET /contacts/{id}</strong> - Get contact by ID</li>
            <li><strong>DELETE /contacts/{id}</strong> - Delete contact</li>
        </ul>
    </div>
    <redoc spec-url='openapi.yaml'></redoc>
    <script src="https://cdn.redoc.ly/redoc/latest/bundles/redoc.standalone.js"></script>
</body>
</html>
EOF
      
      - name: Verify generated documentation
        run: |
          echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ ==="
          ls -la docs/
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v2
        with:
          path: './docs'
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2