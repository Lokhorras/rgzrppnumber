name: Deploy API Documentation

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # –†–∞–∑—Ä–µ—à–∞–µ—Ç —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  security-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: pip install -r requirements.txt
    
    - name: Run Bandit security scan
      run: bandit -r . -f html -o bandit-report.html || true
    
    - name: Upload Bandit report
      uses: actions/upload-artifact@v4
      with:
        name: bandit-report
        path: bandit-report.html

  generate-openapi:
    runs-on: ubuntu-latest
    needs: security-scan
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: pip install -r requirements.txt
    
    - name: Generate OpenAPI specification
      run: |
        python -c "
from app import app
import yaml

# –ü–æ–ª—É—á–∞–µ–º —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—é OpenAPI –∏–∑ Flasgger
spec = app.extensions['flasgger'].swagger

# –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ñ–∞–π–ª
with open('openapi.yaml', 'w', encoding='utf-8') as f:
    yaml.dump(spec, f, allow_unicode=True, default_flow_style=False)

print('‚úÖ OpenAPI specification generated successfully!')
        "
    
    - name: Verify OpenAPI file
      run: |
        echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ OpenAPI —Ñ–∞–π–ª–∞ ==="
        if [ -f openapi.yaml ]; then
          echo "‚úÖ –§–∞–π–ª openapi.yaml —Å–æ–∑–¥–∞–Ω"
          echo "–ü–µ—Ä–≤—ã–µ 10 —Å—Ç—Ä–æ–∫ —Ñ–∞–π–ª–∞:"
          head -20 openapi.yaml
          echo "–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞:"
          ls -lh openapi.yaml
        else
          echo "‚ùå –§–∞–π–ª openapi.yaml –Ω–µ –Ω–∞–π–¥–µ–Ω!"
          exit 1
        fi
    
    - name: Upload OpenAPI spec
      uses: actions/upload-artifact@v4
      with:
        name: openapi-spec
        path: openapi.yaml

  deploy-documentation:
    runs-on: ubuntu-latest
    needs: generate-openapi
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download OpenAPI spec
      uses: actions/download-artifact@v4
      with:
        name: openapi-spec
        path: ./
    
    - name: Setup Pages
      uses: actions/configure-pages@v3
    
    - name: Install Redocly CLI
      run: npm install -g @redocly/cli@latest
    
    - name: Create docs directory
      run: mkdir -p docs
    
    - name: Generate ReDoc documentation
      run: redocly build-docs openapi.yaml --output=docs/index.html
    
    - name: Add custom HTML wrapper
      run: |
        cat > docs/index.html << 'EOF'
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>üì± Phone Contacts API Documentation</title>
    <style>
        body {
            margin: 0;
            padding: 0;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 2.5em;
        }
        .header p {
            margin: 10px 0 0;
            opacity: 0.9;
        }
        .info-box {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 20px;
            margin: 20px;
            border-radius: 5px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .endpoints {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .endpoint-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .endpoint-card h3 {
            margin-top: 0;
            color: #333;
        }
        .method {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: bold;
            margin-right: 10px;
        }
        .method.post { background: #49cc90; color: white; }
        .method.get { background: #61affe; color: white; }
        .method.delete { background: #f93e3e; color: white; }
        .endpoint { font-family: monospace; background: #f5f5f5; padding: 5px; border-radius: 3px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üì± Phone Contacts API</h1>
        <p>–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è REST API –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã–º–∏ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º–∏</p>
    </div>
    
    <div class="container">
        <div class="info-box">
            <h2>–û API</h2>
            <p>–≠—Ç–æ RESTful API –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã–º–∏ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º–∏ —Å –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π.</p>
            <p>–í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–¥–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç –Ω–æ–≤—É—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é —á–µ—Ä–µ–∑ GitHub Actions.</p>
        </div>
        
        <h2>–û—Å–Ω–æ–≤–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã</h2>
        <div class="endpoints">
            <div class="endpoint-card">
                <h3><span class="method post">POST</span> –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞</h3>
                <p class="endpoint">/contacts</p>
                <p>–°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã–π –∫–æ–Ω—Ç–∞–∫—Ç. –¢—Ä–µ–±—É–µ—Ç –∏–º—è –∏ —Ç–µ–ª–µ—Ñ–æ–Ω.</p>
            </div>
            <div class="endpoint-card">
                <h3><span class="method get">GET</span> –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞</h3>
                <p class="endpoint">/contacts/{id}</p>
                <p>–ü–æ–ª—É—á–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–Ω—Ç–∞–∫—Ç–µ –ø–æ –µ–≥–æ ID.</p>
            </div>
            <div class="endpoint-card">
                <h3><span class="method delete">DELETE</span> –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞</h3>
                <p class="endpoint">/contacts/{id}</p>
                <p>–£–¥–∞–ª—è–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç –ø–æ –µ–≥–æ ID.</p>
            </div>
        </div>
        
        <div class="info-box">
            <h2>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏</h2>
            <ul>
                <li><strong>–í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å:</strong> –ò–Ω—Ç—É–∏—Ç–∏–≤–Ω—ã–π UI –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–∞–º–∏</li>
                <li><strong>Swagger UI:</strong> –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API</li>
                <li><strong>–ê–≤—Ç–æ–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:</strong> OpenAPI —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</li>
                <li><strong>–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:</strong> –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ Bandit</li>
                <li><strong>CI/CD:</strong> –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –Ω–∞ GitHub Pages</li>
            </ul>
        </div>
    </div>

    <!-- ReDoc –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è -->
    <div id="redoc-container"></div>
    
    <script src="https://cdn.redoc.ly/redoc/latest/bundles/redoc.standalone.js"></script>
    <script>
        Redoc.init('openapi.yaml', {
            scrollYOffset: 50,
            theme: {
                colors: {
                    primary: { main: '#1890ff' }
                },
                typography: {
                    fontSize: '16px',
                    lineHeight: '1.6'
                }
            }
        }, document.getElementById('redoc-container'));
    </script>
</body>
</html>
EOF
    
    - name: Verify generated documentation
      run: |
        echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ ==="
        echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ docs –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:"
        ls -la docs/
        echo "–†–∞–∑–º–µ—Ä index.html:"
        ls -lh docs/index.html
        echo "–ü–µ—Ä–≤—ã–µ 10 —Å—Ç—Ä–æ–∫ index.html:"
        head -10 docs/index.html
    
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v2
      with:
        path: './docs'
    
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v2